## Exercises {-}

+---------------------------------+-----------------------------------------------------------------------------+
| ![](images/07.png){height="68"} | - Create a new R Studio Project and name it **005_data_wrangling**.         |
|                                 |                                                                             |
|                                 | - Create a new R script, add your name and date at the top as comments.     |
|                                 |                                                                             |
|                                 | - Locate and/or download a Tidyverse cheat-sheet and refer to it as needed. |
+---------------------------------+-----------------------------------------------------------------------------+

1. Download *Bacterial Metabolite Data (long)* to use as an example data file.
```{r, eval=FALSE}
url <- "https://raw.githubusercontent.com/jeffsocal/ASMS_R_Basics/main/data/bacterial-metabolites_dose-simicillin_long.csv"
download.file(url, destfile = "./data/bacterial-metabolites_dose-simicillin_long.csv")
```

2. Read in the dataset .csv using the `tidyverse` set of packages.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(readxl)

tbl_met <- "./data/bacterial-metabolites_dose-simicillin_long.xlsx" %>% read_xlsx()
```

3. How many rows does the table contain? Number of columns? What are the column names?
```{r, echo=FALSE}
tbl_met %>% nrow()
tbl_met %>% ncol()
tbl_met %>% colnames()
```

4. Tidy the data such that culture is separated into *Organism <chr>* and *Dose_mg <dbl>*. Reshape the *Time_* variables such that there is one per row and we have a *Time_min <dbl>* and *Abundance <dbl>* variable. Store the wrangled table as a new object.
```{r, echo=FALSE}
tbl_met_tidy <- tbl_met %>% 
  separate(Culture, into = c('Organism', 'Dose_mg'), sep="dose:") %>%
  mutate(Dose_mg = str_extract(Dose_mg, "[0-9]+") %>% as.numeric()) %>%
  pivot_longer(matches('Time'), names_to = 'Time_min', values_to = 'Abundance') %>%
  mutate(Time_min = str_extract(Time_min, "[0-9]+") %>% as.numeric()) %>%
  mutate(Time_min = ifelse(Time_min == 2, Time_min * 60, Time_min))

tbl_met_tidy
```

5. Write the *tidy* file to a .csv.
```{r, echo=FALSE, eval=FALSE}
tbl_met_tidy %>% write_csv("data/bacterial-metabolites_dose-simicillin_tidy.csv")
```

6. Find the initial conditions for *glutamate*.
```{r, echo=FALSE}
tbl_met_tidy %>% 
  filter(Metabolite == 'glutamate' & Time_min == 0 & Dose_mg == 0)
```

7. Find the average initial condition for each *Metabolite*.
```{r, echo=FALSE}
tbl_met_tidy %>% 
  filter(Time_min == 0 & Dose_mg == 0) %>%
  group_by(Metabolite) %>% 
  summarise(Abundance_avg = mean(Abundance))
```

8. Convert *Abundance* to *Log10 Abundance* and add it as a new column, keeping only 3 significant figures.
```{r, echo=FALSE}
tbl_met_tidy <- tbl_met_tidy %>%
  mutate(Abundance_log10 = signif(log10(Abundance), 3))

tbl_met_tidy
```

9. Create a summary table for the delta change in *Metabolite log10 Abundance* between initial conditions and the last time point, for each *Organism* and *Dose_mg*, arranged by *Organism*. See example below.
```{r, echo=FALSE}
library(glue)

tbl_met_tidy %>%
  filter(Time_min %in% range(Time_min)) %>%
  select(-Abundance) %>%
  mutate(Time_min = glue('Time_{Time_min}min')) %>%
  pivot_wider(names_from = Time_min, values_from = 'Abundance_log10') %>%
  mutate(Delta_log10_Abundance = Time_0min - Time_120min) %>%
  select(!matches('Time')) %>%
  pivot_wider(names_from = 'Metabolite', values_from = 'Delta_log10_Abundance') %>%
  arrange(Organism)
```